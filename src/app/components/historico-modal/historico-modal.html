<div *ngIf="visible" class="modal-backdrop" role="dialog" aria-modal="true" tabindex="-1">
  <div class="modal-content custom-modal-content position-relative">
    <button
      type="button"
      class="btn-close position-absolute"
      aria-label="Fechar"
      (click)="fecharModal()"
      style="top: 1rem; right: 1rem;"
    ></button>

    <!-- Container flexível para dados e histórico lado a lado -->
    <div class="modal-body-flex">
      <!-- Dados do cliente -->
      <app-dados-cliente
        [card]="card!"
        (atualizar)="atualizar.emit($event)"
        class="dados-cliente"
      ></app-dados-cliente>

      <!-- Histórico + formulário -->
      <div class="historico">
        <h4>Histórico do Cliente</h4>

        <!-- Lista de registros -->
        <div *ngIf="card?.historico?.length" class="mb-3">
          <h5>Registros:</h5>
          <ul class="list-group registros-lista">
            <li
              *ngFor="let registro of historicoOrdenado()"
              class="list-group-item d-flex justify-content-between align-items-start"
            >
              <div class="flex-grow-1 me-3 registro-textos">
                <div class="fw-bold">
                  {{ registro.atividade }} — {{ formatarData(registro.data) }}
                </div>
                <div class="descricao-texto">
                  {{ registro.descricao }}
                </div>
              </div>
              <div class="d-flex align-items-start gap-1">
  <ng-container *ngIf="!registro.concluida; else concluidoTemplate">
    <button
      class="btn btn-sm btn-outline-primary"
      (click)="editarRegistro(registro)"
      style="white-space: nowrap;"
    >
      Editar
    </button>

    <!-- Botão Concluir atividade -->
    <button
      class="btn btn-sm btn-success"
      (click)="concluirAtividadeRegistro(registro)"
      title="Concluir atividade"
    >
      ✔
    </button>
  </ng-container>
  <ng-template #concluidoTemplate>
    <span
      class="text-success fw-semibold"
      [title]="'Atividade concluída em ' + formatarData(registro.data)"
      style="font-size: 1.2rem; cursor: default; user-select: none;"
    >
      ✔
    </span>
  </ng-template>
</div>

            </li>
          </ul>
        </div>

        <!-- Formulário de histórico separado -->
        <app-historico-form
          [atividade]="novaAtividade"
          [descricao]="novaDescricao"
          [dataISO]="dataInputISO"
          [concluida]="registroEditando?.concluida ?? false"
          (salvarRegistro)="salvar($event)"
        ></app-historico-form>
      </div>
    </div>
  </div>
</div>

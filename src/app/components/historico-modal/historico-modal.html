<div *ngIf="visible" class="modal-backdrop" role="dialog" aria-modal="true" tabindex="-1">
  <div class="modal-content custom-modal-content position-relative">
    <button
      type="button"
      class="btn-close position-absolute"
      aria-label="Fechar"
      (click)="fecharModal()"
      style="top: 1rem; right: 1rem;"
    ></button>

    <!-- Container flexível para dados e histórico lado a lado -->
    <div class="modal-body-flex">
      <!-- Dados do cliente -->
      <app-dados-cliente
        [card]="card!"
        (atualizar)="atualizar.emit($event)"
        class="dados-cliente"
      ></app-dados-cliente>

      <!-- Histórico + formulário -->
      <div class="historico">

        <!-- Título do formulário -->
        <h3 class="mb-3">Nova Atividade</h3>

        <!-- Formulário -->
        <app-historico-form
          [atividade]="novaAtividade"
          [descricao]="novaDescricao"
          [dataISO]="dataInputISO"
          [concluida]="registroEditando?.concluida ?? false"
          (salvarRegistro)="salvar($event)"
        ></app-historico-form>

        <!-- Linha divisória -->
        <hr class="my-4" />

        <!-- Título e lista de registros -->
        <h3>Histórico do Cliente</h3>

        <div *ngIf="card?.historico?.length" class="mb-3">
          <h5>Registros:</h5>
          <ul class="list-group registros-lista">
            <li
              *ngFor="let registro of historicoOrdenado()"
              class="list-group-item"
            >
              <!-- Texto -->
              <div class="registro-textos">
                <div class="fw-bold">
                  {{ registro.atividade }} — {{ formatarData(registro.data) }}
                </div>
                <div class="descricao-texto">
                  {{ registro.descricao }}
                </div>
              </div>

              <!-- Botões -->
              <div class="acao-botoes">
                <ng-container *ngIf="!registro.concluida; else concluidoTemplate">
                  <button
                    class="btn btn-sm btn-outline-primary"
                    (click)="editarRegistro(registro)"
                    style="white-space: nowrap;"
                  >
                    Editar
                  </button>

                  <button
                    class="btn btn-sm btn-success"
                    (click)="concluirAtividadeRegistro(registro)"
                    title="Concluir atividade"
                  >
                    ✔
                  </button>
                </ng-container>

                <ng-template #concluidoTemplate>
                  <span
                    class="text-success fw-semibold"
                    [title]="'Atividade concluída em ' + formatarData(registro.data)"
                    style="font-size: 1.2rem; cursor: default; user-select: none;"
                  >
                    ✔
                  </span>
                </ng-template>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
